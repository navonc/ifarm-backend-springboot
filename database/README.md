# iFarm 智慧农场数据库设计文档

## 概述

iFarm 是一个电子农场认养模式的微信小程序后端数据库，支持用户认养农场单元、查看生长记录、收获配送等完整业务流程。

## 数据库结构

### 核心业务流程
```
农场创建 → 地块划分 → 认养项目 → 单元认养 → 种植管理 → 收获配送
```

### 表结构概览

#### 1. 用户系统 (2张表)
- **users** - 用户表：存储用户基本信息、微信信息、用户类型等
- **user_addresses** - 收货地址表：用户收货地址管理

#### 2. 系统配置 (2张表)  
- **categories** - 分类表：作物分类等系统分类
- **system_configs** - 系统配置表：系统参数配置

#### 3. 作物系统 (1张表)
- **crops** - 作物品种表：作物基本信息、生长周期、产量等

#### 4. 农场系统 (4张表)
- **farms** - 农场表：农场基本信息、位置、认证等
- **farm_plots** - 地块表：农场下的具体地块信息
- **adoption_projects** - 认养项目表：在地块上创建的认养项目
- **project_units** - 项目单元表：项目下的可认养单元

#### 5. 认养订单系统 (2张表)
- **adoption_orders** - 认养订单表：用户认养支付订单
- **adoption_records** - 认养记录表：用户具体的认养记录

#### 6. 种植管理系统 (2张表)
- **growth_records** - 生长记录表：每日生长情况记录
- **harvest_records** - 收获记录表：收获情况记录

#### 7. 物流配送系统 (2张表)
- **delivery_orders** - 配送订单表：收获后的配送订单
- **delivery_tracking** - 物流跟踪表：物流状态跟踪

#### 8. 媒体资源 (1张表)
- **media_files** - 媒体文件表：图片、视频等文件管理

## 核心业务逻辑

### 认养流程
1. 农场主创建农场和地块
2. 在地块上创建认养项目，设置单元数量和价格
3. 用户浏览项目，选择认养单元数量
4. 创建认养订单，用户支付
5. 支付成功后自动分配单元，创建认养记录

### 种植管理
1. 项目开始种植后，农场主记录每日生长情况
2. 用户可查看自己认养项目的生长记录
3. 收获时记录产量和品质信息

### 配送流程
1. 收获完成后创建配送订单
2. 安排物流配送，记录物流跟踪信息
3. 用户可实时查看配送状态

## 关键特性

### 1. 灵活的层级结构
- 支持一个农场多个地块
- 一个地块可以有多个认养项目
- 一个项目可以划分为多个单元供不同用户认养

### 2. 完整的状态管理
- 项目状态：筹备中、认养中、种植中、收获中、已完成
- 单元状态：可认养、已认养、种植中、待收获、已收获
- 订单状态：待支付、已支付、已完成、已取消

### 3. 丰富的记录系统
- 支持图片、视频等多媒体记录
- 详细的生长过程跟踪
- 完整的收获和配送记录

### 4. 自动化业务处理
- 订单支付成功后自动分配单元
- 自动更新项目可用单元数
- 触发器确保数据一致性

## 视图和存储过程

### 视图
- **v_user_adoptions** - 用户认养项目视图：方便查询用户的认养情况
- **v_project_stats** - 项目统计视图：项目认养统计信息

### 存储过程
- **CreateAdoptionOrder** - 创建认养订单：处理订单创建的复杂逻辑

### 触发器
- **tr_adoption_order_paid** - 订单支付触发器：支付成功后自动分配单元

## 索引优化

所有表都建立了合适的索引：
- 主键索引
- 外键索引  
- 业务查询常用字段索引
- 复合索引优化复杂查询

## 初始化数据

脚本包含了基础的初始化数据：
- 作物分类数据
- 常见作物品种数据
- 系统配置参数

## 使用说明

1. 执行 `ifarm_schema.sql` 创建数据库和表结构
2. 数据库会自动创建为 `ifarm_dev`
3. 包含完整的表结构、索引、视图、存储过程和初始化数据
4. 支持 MySQL 5.7+ 版本

## 扩展性

数据库设计考虑了未来扩展：
- 支持多农场管理
- 灵活的分类系统
- 可扩展的媒体文件管理
- 完善的配置系统

这个设计能够支持电子农场认养模式的完整业务流程，具有良好的扩展性和维护性。
